/*!
 * facade.js v0.3.0-beta.2 2014-06-24T18:26:31
 * https://github.com/facadejs/facade.js
 * 
 * Copyright (c) 2014 Scott Doxey
 * Released under the MIT license.
 */
!function(){"use strict";function a(a){return"[object Function]"===Object.prototype.toString.call(a)?!0:!1}function b(a,c,d){if(!(this instanceof b))return new b(a,c,d);this.dt=null,this.fps=null,this.ftime=null,this._callback=null,this._requestAnimation=null,this._width=null,this._height=null,a&&"object"==typeof a&&1===a.nodeType?this.canvas=a:(this.canvas=document.createElement("canvas"),"string"==typeof a&&this.canvas.setAttribute("id",a)),c&&d?(this.width(c),this.height(d)):(this._width=parseInt(this.canvas.getAttribute("width"),10),this._height=parseInt(this.canvas.getAttribute("height"),10));try{this.context=this.canvas.getContext("2d")}catch(e){throw new Error("Object passed to Facade.js was not a valid canvas element.")}}var c,d,e,f=["fillStyle","font","globalAlpha","globalCompositeOperation","lineCap","lineJoin","lineWidth","miterLimit","shadowBlur","shadowColor","shadowOffsetX","shadowOffsetY","strokeStyle","textAlign","textBaseline"],g=Math.PI/180,h=new RegExp("^[-+]=");"undefined"!==String(typeof window)&&(e=document.createElement("canvas").getContext("2d"),["webkit","moz"].forEach(function(a){c=c||window.requestAnimationFrame||window[a+"RequestAnimationFrame"]||null,d=d||window.cancelAnimationFrame||window[a+"CancelAnimationFrame"]||null})),b.prototype.addToStage=function(a,c){var d,e;if(a instanceof b.Entity)a.draw(this,c);else{if(!Array.isArray(a))throw new Error("Object passed to Facade.addToStage is not a valid Facade.js entity.");for(d=0,e=a.length;e>d;d+=1)this.addToStage(a[d],c)}return this},b.prototype.clear=function(){return this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this},b.prototype.draw=function(a){if("function"!=typeof a)throw new Error("Parameter passed to Facade.draw is not a valid function");return this._callback=a,this.start(),this},b.prototype.exportBase64=function(a,b){return a||(a="image/png"),"number"==typeof b?b/=100:b=1,this.canvas.toDataURL(a,b)},b.prototype.height=function(a){return a&&(this._height=parseInt(a,10),this.canvas.hasAttribute("data-resized-for-hdpi")?this.resizeForHDPI():this.canvas.setAttribute("height",this._height)),this._height},b.prototype.renderWithContext=function(b,c){var d,e,g=Object.keys(b);for(this.context.save(),d=0,e=g.length;e>d;d+=1)Array.isArray(b[g[d]])&&a(this.context[g[d]])?this.context[g[d]].apply(this.context,b[g[d]]):-1!==f.indexOf(g[d])&&(this.context[g[d]]=b[g[d]]);c&&c.call(null,this),this.context.restore()},b.prototype.resizeForHDPI=function(a){return a=void 0===a?window.devicePixelRatio:parseFloat(a),a>1&&(this.canvas.setAttribute("style","width: "+this.width()+"px; height: "+this.height()+"px;"),this.canvas.setAttribute("width",this.width()*a),this.canvas.setAttribute("height",this.height()*a),this.context.scale(a,a),this.canvas.setAttribute("data-resized-for-hdpi",!0)),this},b.prototype.start=function(){return this._requestAnimation=c(this._animate.bind(this)),this},b.prototype.stop=function(){return this.dt=null,this.fps=null,this.ftime=null,d(this._requestAnimation),this._requestAnimation=null,this},b.prototype.width=function(a){return a&&(this._width=parseInt(a,10),this.canvas.hasAttribute("data-resized-for-hdpi")?this.resizeForHDPI():this.canvas.setAttribute("width",this._width)),this._width},b.prototype._animate=function(a){return"function"==typeof this._callback?(this.ftime&&(this.dt=a-this.ftime,this.fps=(1e3/this.dt).toFixed(2)),this.ftime=a,this._requestAnimation=c(this._animate.bind(this)),this.context.save(),this._callback(),this.context.restore()):this.stop(),this},b.Entity=function(){return this instanceof b.Entity?(this._options=this._defaultOptions(),this._metrics=this._defaultMetrics(),void this.setOptions()):new b.Entity},b.Entity.prototype._defaultOptions=function(a){var b,c,d,e;if(b={x:0,y:0,anchor:"top/left",rotate:0,scale:1},"object"==typeof a)for(c=Object.keys(a),d=0,e=c.length;e>d;d+=1)b[c[d]]=a[c[d]];return b},b.Entity.prototype._defaultMetrics=function(a){var b,c,d,e={x:null,y:null,width:null,height:null};if("object"==typeof a)for(b=Object.keys(a),c=0,d=b.length;d>c;c+=1)e[b[c]]=a[b[c]];return e},b.Entity.prototype._getAnchorPoint=function(a,c){var d,e=[0,0];return a.anchor.match(/center$/)?e[0]=-c.width/2:a.anchor.match(/right$/)&&(e[0]=-c.width),a.anchor.match(/^center/)?e[1]=-c.height/2:a.anchor.match(/^bottom/)&&(e[1]=-c.height),this instanceof b.Polygon&&(d=this._getStrokeWidthOffset(a),e[0]=e[0]+d,e[1]=e[1]+d),e},b.Entity.prototype._getStrokeWidthOffset=function(a){var b=0;return void 0!==a.lineWidth&&(b=a.lineWidth/2),b},b.Entity.prototype._applyTransforms=function(a,b,c){var d=this._getAnchorPoint(b,{x:c.x,y:c.y,width:c.width/b.scale,height:c.height/b.scale});a.translate.apply(a,d),b.rotate&&(a.translate(-d[0],-d[1]),a.rotate(b.rotate*g),a.translate(d[0],d[1])),1!==b.scale&&(a.translate(-d[0],-d[1]),a.scale(b.scale,b.scale),a.translate(d[0],d[1]))},b.Entity.prototype.getOption=function(a){return void 0!==this._options[a]?this._options[a]:void 0},b.Entity.prototype.getAllOptions=function(){var a,b,c={},d=Object.keys(this._options);for(a=0,b=d.length;b>a;a+=1)c[d[a]]=this._options[d[a]];return c},b.Entity.prototype._setOption=function(a,b,c){if(void 0!==this._options[a]){if("number"==typeof this._options[a]&&"string"==typeof b&&(b=b.match(h)?this._options[a]+parseFloat(b.replace("=","")):parseFloat(b)),String(typeof this._options[a])!==String(typeof b))throw new Error("The value for "+a+" ("+b+") was a "+String(typeof b)+" not a "+String(typeof this._options[a])+".");return c||(this._options[a]=b),b}return void 0},b.Entity.prototype.setOptions=function(a,b){var c,d=this.getAllOptions();if(a){for(c in a)void 0!==a[c]&&void 0!==d[c]&&(d[c]=this._setOption(c,a[c],b));b||this._setMetrics()}return d},b.Entity.prototype.getMetric=function(a){return void 0!==this._metrics[a]?this._metrics[a]:void 0},b.Entity.prototype.getAllMetrics=function(){var a,b,c={},d=Object.keys(this._metrics);for(a=0,b=d.length;b>a;a+=1)c[d[a]]=this._metrics[d[a]];return c},b.Entity.prototype.draw=function(b,c){var d,e=this.setOptions(c,!0);a(this._configOptions)&&(e=this._configOptions(e)),d=c?this._setMetrics(e):this.getAllMetrics(),a(this._draw)&&b.renderWithContext(e,this._draw.bind(this,b,e,d))},b.Polygon=function(a){return this instanceof b.Polygon?(this._options=this._defaultOptions(),this._metrics=this._defaultMetrics(),void this.setOptions(a)):new b.Polygon(a)},b.Polygon.prototype=Object.create(b.Entity.prototype),b.Polygon.constructor=b.Entity,b.Polygon.prototype._defaultOptions=function(a){var c,d;c=b.Entity.prototype._defaultOptions({opacity:100,shadowBlur:0,shadowColor:"#000",shadowOffsetX:0,shadowOffsetY:0,points:[],fillStyle:"#000",strokeStyle:"",lineWidth:0,lineCap:"butt",lineJoin:"miter",closePath:!0});for(d in a)void 0!==a[d]&&(c[d]=a[d]);return c},b.Polygon.prototype._draw=function(a,b,c){var d,e,f=a.context;if(this._applyTransforms(f,b,c),b.points.length){for(f.beginPath(),d=0,e=b.points.length;e>d;d+=1)6===b.points[d].length?f.bezierCurveTo.apply(f,b.points[d]):5===b.points[d].length?f.arc.apply(f,b.points[d]):2===b.points[d].length&&f.lineTo.apply(f,b.points[d]);b.closePath?f.closePath():f.moveTo.apply(f,b.points[e-1]),b.fillStyle&&f.fill(),b.lineWidth>0&&f.stroke()}},b.Polygon.prototype._configOptions=function(a){return a.translate=[a.x,a.y],a.globalAlpha=a.opacity/100,a},b.Polygon.prototype._setMetrics=function(c){var d,e,f,g,h=this._defaultMetrics(),i=c||this.getAllOptions(),j={top:null,right:null,bottom:null,left:null},k=this._getStrokeWidthOffset(i);for(a(this._configOptions)&&(i=this._configOptions(i)),e=0,f=i.points.length;f>e;e+=1)2===i.points[e].length?d={x:i.points[e][0],y:i.points[e][1]}:5===i.points[e].length&&(h.width=2*i.points[e][2],h.height=2*i.points[e][2],d={x:i.points[e][0]-i.points[e][2],y:i.points[e][1]-i.points[e][2]}),(d.x<j.left||null===j.left)&&(j.left=d.x),(d.y<j.top||null===j.top)&&(j.top=d.y),(d.x>j.right||null===j.right)&&(j.right=d.x),(d.y>j.bottom||null===j.bottom)&&(j.bottom=d.y);return h.x=i.x+j.left,h.y=i.y+j.top,null===h.width&&null===h.height&&(h.width=j.right-j.left,h.height=j.bottom-j.top),h.width=(h.width+2*k)*i.scale,h.height=(h.height+2*k)*i.scale,g=this._getAnchorPoint(i,h),h.x=h.x+g[0]-k,h.y=h.y+g[1]-k,this instanceof b.Circle&&(h.x=h.x+i.radius,h.y=h.y+i.radius),c||(this._metrics=h),h},b.Circle=function(a){return this instanceof b.Circle?(this._options=this._defaultOptions({radius:0,begin:0,end:360,counterclockwise:!1}),this._metrics=this._defaultMetrics(),void this.setOptions(a)):new b.Circle(a)},b.Circle.prototype=Object.create(b.Polygon.prototype),b.Circle.constructor=b.Polygon,b.Circle.prototype._configOptions=function(a){return a.translate=[a.x,a.y],a.globalAlpha=a.opacity/100,a.points=a.counterclockwise?[[0,0,a.radius,a.end*g,a.begin*g]]:[[0,0,a.radius,a.begin*g,a.end*g]],a},b.Circle.prototype._getAnchorPoint=function(a,c){var d=b.Polygon.prototype._getAnchorPoint.call(this,a,c);return d[0]=d[0]+a.radius,d[1]=d[1]+a.radius,d},b.Circle.prototype._setMetrics=function(a){var c=b.Polygon.prototype._setMetrics.call(this,a),d=this.getAllOptions(a);return c.x=c.x-d.radius,c.y=c.y-d.radius,a||(this._metrics=c),c},b.Line=function(a){return this instanceof b.Line?(this._options=this._defaultOptions({x1:0,y1:0,x2:0,y2:0,lineWidth:1}),this._metrics=this._defaultMetrics(),void this.setOptions(a)):new b.Line(a)},b.Line.prototype=Object.create(b.Polygon.prototype),b.Line.constructor=b.Polygon,b.Line.prototype._configOptions=function(a){return a.translate=[a.x,a.y],a.globalAlpha=a.opacity/100,a.closePath=!1,a.points=[[a.x1,a.y1],[a.x2,a.y2]],a},b.Line.prototype._getAnchorPoint=function(a,b){var c=[0,0];return a.anchor.match(/center$/)?c[0]=-(b.width/2-a.lineWidth/2):a.anchor.match(/right$/)&&(c[0]=-(b.width-a.lineWidth)),a.anchor.match(/^center/)?c[1]=-(b.height/2-a.lineWidth/2):a.anchor.match(/^bottom/)&&(c[1]=-(b.height-a.lineWidth)),c},b.Rect=function(a){return this instanceof b.Rect?(this._options=this._defaultOptions({width:0,height:0}),this._metrics=this._defaultMetrics(),void this.setOptions(a)):new b.Rect(a)},b.Rect.prototype=Object.create(b.Polygon.prototype),b.Rect.constructor=b.Polygon,b.Rect.prototype._configOptions=function(a){return a.translate=[a.x,a.y],a.globalAlpha=a.opacity/100,a.points=[[0,0],[a.width,0],[a.width,a.height],[0,a.height]],a},b.Image=function(a,c){return this instanceof b.Image?(this._options=this._defaultOptions({width:0,height:0,tileX:1,tileY:1,offsetX:0,offsetY:0,frames:[0],speed:120,loop:!0,callback:function(){return void 0}}),this._metrics=this._defaultMetrics(),this.animating=!1,this.currentFrame=0,this.setOptions(c),void this.load(a)):new b.Image(a,c)},b.Image.prototype=Object.create(b.Entity.prototype),b.Image.constructor=b.Entity,b.Image.prototype.load=function(a){"object"==typeof a&&1===a.nodeType?this.image=a:(this.image=document.createElement("img"),this.image.setAttribute("src",a)),this.image.complete?this._setMetrics():this.image.addEventListener("load",this._setMetrics.bind(this,null))},b.Image.prototype.play=function(){return this.animating=!0,this},b.Image.prototype.pause=function(){return this.animating=!1,this},b.Image.prototype.reset=function(){return this.currentFrame=0,this},b.Image.prototype.stop=function(){return this.currentFrame=0,this.animating=!1,this},b.Image.prototype._configOptions=function(a){return a.translate=[a.x,a.y],this.image&&this.image.complete&&(a.width||(a.width=this.image.width),a.height||(a.height=this.image.height)),a},b.Image.prototype._setMetrics=function(b){var c,d=this._defaultMetrics(),e=b||this.getAllOptions();return a(this._configOptions)&&(e=this._configOptions(e)),d.width=e.width*e.tileX*e.scale,d.height=e.height*e.tileY*e.scale,c=this._getAnchorPoint(e,d),d.x=e.x+c[0],d.y=e.y+c[1],b||(this._metrics=d),d},b.Image.prototype._draw=function(a,b,c){var d,e,f=a.context,g=0,h=0;if(this.image.complete){for(this._applyTransforms(f,b,c),b.frames.length&&(g=b.frames[this.currentFrame]||0),d=0;d<b.tileX;d+=1)for(e=0;e<b.tileY;e+=1)f.drawImage(this.image,b.width*g+b.offsetX,b.height*h+b.offsetY,b.width,b.height,b.width*d,b.height*e,b.width,b.height);this.animating&&(this.ftime||(this.ftime=a.ftime,"function"==typeof b.callback&&b.callback.call(this,b.frames[this.currentFrame])),a.ftime-this.ftime>=b.speed&&(this.ftime=a.ftime,this.currentFrame+=1,this.currentFrame>=b.frames.length&&(b.loop?this.currentFrame=0:(this.currentFrame=b.frames.length-1,this.isAnimating=!1)),"function"==typeof b.callback&&b.callback.call(this,b.frames[this.currentFrame])))}},b.Text=function(a,c){return this instanceof b.Text?(void 0!==a&&(this.value=String(a)),this._options=this._defaultOptions({opacity:100,width:0,fontFamily:"Arial",fontStyle:"normal",fontSize:16,lineHeight:1,textAlignment:"left",textBaseline:"top",fillStyle:"#000",strokeStyle:"#000",lineWidth:0}),this._metrics=this._defaultMetrics(),this._maxLineWidth=0,this._lines=[],this.setOptions(c),void this.setText(this.value)):new b.Text(a,c)},b.Text.prototype=Object.create(b.Entity.prototype),b.Text.constructor=b.Entity,b.Text.prototype.setText=function(b){var c,d,f=this.getAllOptions(),g=[],h=null,i="",j=0;for(this._maxLineWidth=f.width,this._lines=[],b&&(g=String(b).match(/\n|[\S]+ ?/g)),a(this._configOptions)&&(f=this._configOptions(f)),e.save(),e.font=f.font;g.length;)h=g.shift(),j=e.measureText(i+h.replace(/\s$/,"")).width,f.width>0&&j>f.width||h.match(/\n/)?(this._lines.push([i.replace(/\s$/,""),0,this._lines.length*f.fontSize*f.lineHeight]),i=h.replace(/\n/,"")):(i+=h,j>this._maxLineWidth&&(this._maxLineWidth=j));for(this._lines.push([i.replace(/\s$/,""),0,this._lines.length*f.fontSize*f.lineHeight]),c=0,d=this._lines.length;d>c;c+=1)j=e.measureText(this._lines[c][0]).width,"center"===f.textAlignment?this._lines[c][1]=(this._maxLineWidth-j)/2:"right"===f.textAlignment&&(this._lines[c][1]=this._maxLineWidth-j);return e.restore(),this._setMetrics(),this._lines},b.Text.prototype._draw=function(a,b,c){var d,e,f=a.context;for(this._applyTransforms(f,b,c),d=0,e=this._lines.length;e>d;d+=1)f.fillText.apply(f,this._lines[d]),b.lineWidth&&f.strokeText.apply(f,this._lines[d])},b.Text.prototype._configOptions=function(a){return a.translate=[a.x,a.y],a.globalAlpha=a.opacity/100,a.font=a.fontStyle+" "+parseInt(a.fontSize,10)+"px "+a.fontFamily,0===a.width&&(a.width=this._maxLineWidth),a},b.Text.prototype._setMetrics=function(b){var c,d=this._defaultMetrics(),e=b||this.getAllOptions();return a(this._configOptions)&&(e=this._configOptions(e)),this._lines&&(d.width=e.width*e.scale,d.height=this._lines.length*e.fontSize*e.lineHeight*e.scale),c=this._getAnchorPoint(e,d),d.x=e.x+c[0],d.y=e.y+c[1],b||(this._metrics=d),d},b.Group=function(a){return this instanceof b.Group?(this._options=this._defaultOptions(),this._metrics=this._defaultMetrics(),this._objects=[],void this.setOptions(a)):new b.Group(a)},b.Group.prototype=Object.create(b.Entity.prototype),b.Group.constructor=b.Entity,b.Group.prototype._draw=function(a,b,c){var d,e,f=a.context;for(this._applyTransforms(f,b,c),d=0,e=this._objects.length;e>d;d+=1)a.addToStage(this._objects[d])},b.Group.prototype._configOptions=function(a){return a.translate=[a.x,a.y],a},b.Group.prototype.addToGroup=function(a){var c,d;if(a instanceof b.Entity)-1===this._objects.indexOf(a)&&(this._objects.push(a),this._setMetrics());else{if(!Array.isArray(a))throw new Error("Object passed to Facade.addToStage is not a valid Facade.js entity.");for(c=0,d=a.length;d>c;c+=1)this.addToGroup(a[c])}},b.Group.prototype.hasEntity=function(a){return-1!==this._objects.indexOf(a)},b.Group.prototype.removeFromGroup=function(a){a instanceof b.Entity&&-1!==this._objects.indexOf(a)&&(this._objects.splice(this._objects.indexOf(a),1),this._setMetrics())},b.Group.prototype._setMetrics=function(a){var b,c,d,e,f=this._defaultMetrics(),g=a||this.getAllOptions(),h={top:null,right:null,bottom:null,left:null};for(b=0,c=this._objects.length;c>b;b+=1)e=this._objects[b].getAllMetrics(),(e.x<h.left||null===h.left)&&(h.left=e.x),(e.y<h.top||null===h.top)&&(h.top=e.y),(e.x+e.width>h.right||null===h.right)&&(h.right=e.x+e.width),(e.y+e.height>h.bottom||null===h.bottom)&&(h.bottom=e.y+e.height);return f.x=g.x+h.left,f.y=g.y+h.top,f.width=(h.right-h.left)*g.scale,f.height=(h.bottom-h.top)*g.scale,d=this._getAnchorPoint(g,f),f.x=g.x+d[0],f.y=g.y+d[1],a||(this._metrics=f),f},"function"==typeof define&&void 0!==define.amd?define([],function(){return b}):"object"==typeof module&&void 0!==module.exports?module.exports=b:window.Facade=b}();