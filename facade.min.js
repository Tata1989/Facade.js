/*!
 * Facade.js (facadejs.com)
 * Copyright (c) 2013 Scott Doxey
 * Dual-licensed under both MIT and BSD licenses.
 */
/*jslint browser: true*/
/*jslint nomen: true*/
window.Facade=function(){"use strict";["webkit","moz"].forEach(function(t){window.requestAnimationFrame=window.requestAnimationFrame||window[t+"RequestAnimationFrame"]||null;window.cancelAnimationFrame=window.cancelAnimationFrame||window[t+"CancelAnimationFrame"]||null});var t=function(i,e,s){if(!(this instanceof t)){return new t(i,e,s)}if(i&&typeof i==="object"&&i.nodeType===1){this.canvas=i}else{this.canvas=document.createElement("canvas");if(typeof i==="string"){this.canvas.setAttribute("id",i)}if(e&&s){this.canvas.setAttribute("width",parseInt(e,10));this.canvas.setAttribute("height",parseInt(s,10))}}try{this.context=this.canvas.getContext("2d")}catch(n){throw new Error("Object passed to Facade.js is not a valid canvas element.")}this.dt=0;this.fps=0;this.ftime=null;this.callback=null;this.requestAnimation=null};t.prototype.addToStage=function(i,e){if(!(i instanceof t.Entity)){throw new Error("Object passed to Facade.addToStage is not a valid Facade.js object.")}var s,n,o,h,a,r,l;e=i.setOptions(e,true);this.context.save();this.setAnchorPoint.call(this,i,e);s=i.getAllMetrics();if(!(i instanceof t.Image)){if(s.x+s.width<0||s.y+s.height<0||s.x>this.canvas.width||s.y>this.canvas.height){this.context.restore();return this}}this.context.scale(e.scale,e.scale);this.setRotate.call(this,i,e);if(e.fillStyle){this.context.fillStyle=e.fillStyle}this.context.globalAlpha=e.opacity/100;if(e.lineCap){this.context.lineCap=e.lineCap}if(e.lineWidth){this.context.strokeStyle=e.strokeStyle;this.context.lineWidth=e.lineWidth}if(e.shadowBlur){this.context.shadowBlur=e.shadowBlur;this.context.shadowColor=e.shadowColor;this.context.shadowOffsetX=e.shadowOffsetX;this.context.shadowOffsetY=e.shadowOffsetY}if(i instanceof t.Circle){this.context.beginPath();this.context.arc(0,0,e.radius,e.start*Math.PI/180,e.end*Math.PI/180,e.counterclockwise);if(e.fillStyle){this.context.fill()}if(e.strokePosition==="inset"){this.context.closePath();this.context.beginPath();this.context.arc(0,0,e.radius-e.lineWidth/2,e.start*Math.PI/180,e.end*Math.PI/180,e.counterclockwise)}else if(e.strokePosition==="outset"){this.context.closePath();this.context.beginPath();this.context.arc(0,0,e.radius+e.lineWidth/2,e.start*Math.PI/180,e.end*Math.PI/180,e.counterclockwise)}if(e.lineWidth){this.context.stroke()}this.context.closePath()}else if(i instanceof t.Image&&i.isLoaded){o=0;if(e.frames.length){o=e.frames[i.frame]}for(r=0;r<e.tileX;r+=1){for(l=0;l<e.tileY;l+=1){if(s.x+e.width*(r+1)<0||s.y+e.height*(l+1)<0||s.x+e.width*r>this.canvas.width||s.y+e.height*l>this.canvas.height){break}i.setMetrics({width:s.width*(r+1),height:s.height*(l+1)});this.context.drawImage(i.img,e.width*o+e.offsetX,e.offsetY,e.width,e.height,e.width*r,e.height*l,e.width,e.height)}}if(e.frames.length){if(!i.ftime){i.ftime=this.ftime;if(typeof e.callback==="function"){e.callback.call(i,e.frames[i.frame])}}if(this.ftime-i.ftime>=e.speed){i.ftime=this.ftime;i.frame+=1;if(i.frame>=e.frames.length){if(e.loop){i.frame=0}else{i.frame=e.frames.length-1}}if(typeof e.callback==="function"){e.callback.call(i,e.frames[i.frame])}}}}else if(i instanceof t.Line){this.context.beginPath();this.context.moveTo(0,0);this.context.lineTo(e.endX-e.startX,e.endY-e.startY);this.context.stroke();this.context.closePath()}else if(i instanceof t.Rect){this.context.beginPath();if(e.borderRadius){n=Math.min(e.borderRadius,e.height/2,e.width/2);this.context.moveTo(n,0);this.context.arc(e.width-n,n,n,Math.PI*1.5,0);this.context.arc(e.width-n,e.height-n,n,0,Math.PI*.5);this.context.arc(n,e.height-n,n,Math.PI*.5,Math.PI);this.context.arc(n,n,n,Math.PI,Math.PI*1.5);if(e.fillStyle){this.context.fill()}if(e.lineWidth){this.context.stroke()}}else{if(e.fillStyle){this.context.fillRect(0,0,e.width,e.height)}if(e.lineWidth){if(e.strokePosition==="inset"){this.context.closePath();this.context.beginPath();this.context.strokeRect(e.lineWidth/2,e.lineWidth/2,e.width-e.lineWidth,e.height-e.lineWidth)}else if(e.strokePosition==="outset"){this.context.closePath();this.context.beginPath();this.context.strokeRect(-e.lineWidth/2,-e.lineWidth/2,e.width+e.lineWidth,e.height+e.lineWidth)}else{this.context.strokeRect(0,0,e.width,e.height)}}}this.context.closePath()}else if(i instanceof t.Text){this.context.font=e.fontStyle+" "+parseInt(e.fontSize,10)+"px "+e.fontFamily;this.context.textBaseline=e.textBaseline;if(typeof e.value==="string"){e.value=e.value.split(/[ ]*\n[ ]*/)}if(e.lineHeight===null){e.lineHeight=e.fontSize}for(h=0,a=e.value.length;h<a;h+=1){if(e.fillStyle){this.context.fillText(e.value[h],0,h*parseInt(e.lineHeight,10))}if(e.lineWidth){this.context.strokeText(e.value[h],0,h*parseInt(e.lineHeight,10))}}}this.context.restore();return this};t.prototype.animate=function(t){if(typeof this.callback==="function"){if(this.ftime){this.dt=t-this.ftime;this.fps=(1e3/this.dt).toFixed(2)}this.requestAnimation=window.requestAnimationFrame(this.animate.bind(this));this.ftime=t;this.callback.call(this)}else{this.stop()}return this};t.prototype.clear=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);return this};t.prototype.draw=function(t){this.callback=t;this.start();return this};t.prototype.exportBase64=function(t,i){if(!t){t="image/png"}if(typeof i==="number"){i=i/100}else{i=1}return this.canvas.toDataURL(t,i)};t.prototype.setAnchorPoint=function(i,e){var s=0,n=0,o,h;if(i instanceof t.Circle){e.width=e.radius*2;e.height=e.radius*2}else if(i instanceof t.Line){e.width=Math.abs(e.endX-e.startX);e.height=Math.abs(e.endY-e.startY)}else if(i instanceof t.Text){this.context.font=e.fontStyle+" "+parseInt(e.fontSize,10)+"px "+e.fontFamily;if(typeof e.value==="string"){e.value=e.value.split(/[ ]*\n[ ]*/)}if(e.lineHeight===null){e.lineHeight=e.fontSize}e.width=0;for(o=0,h=e.value.length;o<h;o+=1){e.width=Math.max(e.width,this.context.measureText(e.value[o]).width)}e.height=h*parseInt(e.lineHeight,10)}i.setMetrics({width:e.width*e.scale,height:e.height*e.scale});if(typeof e.lineWidth!=="undefined"){if(e.strokePosition==="default"){i.setMetrics({width:i.getMetric("width")+e.lineWidth/2,height:i.getMetric("height")+e.lineWidth/2})}else if(e.strokePosition==="outset"){i.setMetrics({width:i.getMetric("width")+e.lineWidth,height:i.getMetric("height")+e.lineWidth})}}if(e.anchor.match(/^top/)){if(typeof e.radius!=="undefined"){n=e.radius}if(typeof e.lineWidth!=="undefined"){if(e.strokePosition==="default"){n+=e.lineWidth/2}else if(e.strokePosition==="outset"){n+=e.lineWidth}}}else if(e.anchor.match(/^bottom/)){if(typeof e.radius!=="undefined"){n=-e.radius}else{n=-e.height}if(typeof e.lineWidth!=="undefined"){if(e.strokePosition==="default"){n-=e.lineWidth/2}else if(e.strokePosition==="outset"){n-=e.lineWidth}}}else if(e.anchor.match(/^center/)){if(typeof e.radius==="undefined"){n=-(e.height/2)}}if(e.anchor.match(/left$/)){if(typeof e.radius!=="undefined"){s=e.radius}if(typeof e.lineWidth!=="undefined"){if(e.strokePosition==="default"){s+=e.lineWidth/2}else if(e.strokePosition==="outset"){s+=e.lineWidth}}}else if(e.anchor.match(/right$/)){if(typeof e.radius!=="undefined"){s=-e.radius}else{s=-e.width}if(typeof e.lineWidth!=="undefined"){if(e.strokePosition==="default"){s-=e.lineWidth/2}else if(e.strokePosition==="outset"){s-=e.lineWidth}}}else if(e.anchor.match(/center$/)){if(typeof e.radius==="undefined"){s=-(e.width/2)}}s=s*e.scale+e.x;n=n*e.scale+e.y;if(i instanceof t.Circle){i.setMetrics({x:s-i.getMetric("width")/2,y:n-i.getMetric("height")/2})}else{i.setMetrics({x:s,y:n})}this.context.translate(s,n);return this};t.prototype.setRotate=function(t,i){var e,s=0,n=0;e=t.getAllMetrics();if(i.anchor.match(/^bottom/)){n=e.height}else if(i.anchor.match(/^center/)){n=e.height/2}if(i.anchor.match(/right$/)){s=e.width}else if(i.anchor.match(/center$/)){s=e.width/2}if(i.rotate){this.context.translate(s,n);this.context.rotate(i.rotate*Math.PI/180);this.context.translate(-s,-n)}return this};t.prototype.start=function(){this.requestAnimation=window.requestAnimationFrame(this.animate.bind(this));return this};t.prototype.stop=function(){this.dt=0;this.fps=0;this.ftime=0;this.requestAnimation=window.cancelAnimationFrame(this.requestAnimation);return this};t.Entity=function(){};t.Entity.prototype.defaultOptions=function(){var i={x:0,y:0,shadowBlur:0,shadowColor:"#000",shadowOffsetX:0,shadowOffsetY:0,anchor:"top/left",opacity:100,rotate:0,scale:1};if(this instanceof t.Circle){i.radius=10;i.start=0;i.end=360;i.counterclockwise=false;i.fillStyle="#000";i.strokeStyle="#000";i.strokePosition="default";i.lineWidth=0}else if(this instanceof t.Image){i.width=null;i.height=null;i.offsetX=0;i.offsetY=0;i.tileX=1;i.tileY=1;i.frames=[];i.speed=120;i.loop=true;i.callback=function(t){}}else if(this instanceof t.Line){i.startX=0;i.startY=0;i.endX=0;i.endY=0;i.strokeStyle="#000";i.lineWidth=0;i.lineCap=null}else if(this instanceof t.Rect){i.width=100;i.height=100;i.fillStyle="#000";i.strokeStyle="#000";i.strokePosition="default";i.lineWidth=0;i.borderRadius=0}else if(this instanceof t.Text){i.value="";i.fontFamily="Arial";i.fontSize=30;i.fontStyle="normal";i.lineHeight=null;i.textBaseline="top";i.fillStyle="#000";i.strokeStyle="#000";i.lineWidth=0}return i};t.Entity.prototype.getOption=function(t){if(this._options.hasOwnProperty(t)){return this._options[t]}return false};t.Entity.prototype.getAllOptions=function(){var t={},i;for(i in this._options){if(this._options.hasOwnProperty(i)){t[i]=this._options[i]}}return t};t.Entity.prototype.setOptions=function(t,i){var e={},s;for(s in this._options){if(this._options.hasOwnProperty(s)){if(t&&t.hasOwnProperty(s)){e[s]=t[s];if(i!==true){this._options[s]=t[s]}}else{e[s]=this._options[s]}}}return e};t.Entity.prototype.defaultMetrics=function(){var t={x:null,y:null,width:null,height:null};return t};t.Entity.prototype.getMetric=function(t){if(this._metrics.hasOwnProperty(t)){return this._metrics[t]}return false};t.Entity.prototype.getAllMetrics=function(){var t={},i;for(i in this._metrics){if(this._metrics.hasOwnProperty(i)){t[i]=this._metrics[i]}}return t};t.Entity.prototype.setMetrics=function(t,i){var e={},s;for(s in this._metrics){if(this._metrics.hasOwnProperty(s)){if(t&&t.hasOwnProperty(s)){e[s]=t[s];if(i!==true){this._metrics[s]=t[s]}}else{e[s]=this._metrics[s]}}}return e};t.Circle=function(i){if(!(this instanceof t.Circle)){return new t.Circle(i)}this._options=this.defaultOptions();this._metrics=this.defaultMetrics();this.setOptions(i)};t.Circle.prototype=Object.create(t.Entity.prototype);t.Image=function(i,e){if(!(this instanceof t.Image)){return new t.Image(e)}this._options=this.defaultOptions();this._metrics=this.defaultMetrics();if(i===undefined){throw new Error('Required parameter "source" missing from Facade.Image call.')}this.img=null;this.frame=0;this.ftime=null;this.isLoaded=false;this.size={width:null,height:null};this.loaded=function(){var t=this.getAllOptions();this.isLoaded=true;this.size={width:this.img.width,height:this.img.height};if(!t.width||t.width+t.offsetX>this.size.width){this.setOptions({width:this.size.width-this._options.offsetX})}if(!t.height||t.height+t.offsetY>this.size.height){this.setOptions({height:this.size.height-this._options.offsetY})}};if(typeof i==="object"&&i.nodeType===1){this.img=i;if(this.img.complete){this.loaded.call(this)}else{this.img.addEventListener("load",this.loaded.bind(this))}}else{this.img=document.createElement("img");this.img.setAttribute("src",i);this.img.addEventListener("load",this.loaded.bind(this))}this.setOptions(e)};t.Image.prototype=Object.create(t.Entity.prototype);t.Line=function(i){if(!(this instanceof t.Line)){return new t.Line(i)}this._options=this.defaultOptions();this._metrics=this.defaultMetrics();this.setOptions(i)};t.Line.prototype=Object.create(t.Entity.prototype);t.Rect=function(i){if(!(this instanceof t.Rect)){return new t.Rect(i)}this._options=this.defaultOptions();this._metrics=this.defaultMetrics();this.setOptions(i)};t.Rect.prototype=Object.create(t.Entity.prototype);t.Text=function(i){if(!(this instanceof t.Text)){return new t.Text(i)}this._options=this.defaultOptions();this._metrics=this.defaultMetrics();this.setOptions(i)};t.Text.prototype=Object.create(t.Entity.prototype);return t}();