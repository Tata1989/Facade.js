/*!
 * Facade.js (facadejs.com)
 * Copyright (c) 2013 Scott Doxey
 * Dual-licensed under both MIT and BSD licenses.
 */
/*jslint browser: true*/
/*jslint nomen: true*/
window.Facade=function(){"use strict";["webkit","moz"].forEach(function(t){window.requestAnimationFrame=window.requestAnimationFrame||window[t+"RequestAnimationFrame"]||null;window.cancelAnimationFrame=window.cancelAnimationFrame||window[t+"CancelAnimationFrame"]||null});var t=function(e,i,s){if(!(this instanceof t)){return new t(e,i,s)}if(e&&typeof e==="object"&&e.nodeType===1){this.canvas=e}else{this.canvas=document.createElement("canvas");if(typeof e==="string"){this.canvas.setAttribute("id",e)}if(i&&s){this.canvas.setAttribute("width",parseInt(i,10));this.canvas.setAttribute("height",parseInt(s,10))}}try{this.context=this.canvas.getContext("2d")}catch(n){throw new Error("Object passed to Facade.js is not a valid canvas element.")}this.dt=0;this.fps=0;this.ftime=null;this.callback=null;this.requestAnimation=null};t.prototype.addToStage=function(e,i){if(!(e instanceof t.Entity)){throw new Error("Object passed to Facade.addToStage is not a valid Facade.js object.")}var s,n,o=0,h,a,r,l;i=e.setOptions(i,true);this.context.save();this.setAnchorPoint.call(this,e,i);s=e.getAllMetrics();if(!(e instanceof t.Image)){if(s.x+s.width<0||s.y+s.height<0||s.x>this.canvas.width||s.y>this.canvas.height){this.context.restore();return this}}this.context.scale(i.scale,i.scale);this.setRotate.call(this,e,i);if(i.fillStyle){this.context.fillStyle=i.fillStyle}this.context.globalAlpha=i.opacity/100;if(i.lineCap){this.context.lineCap=i.lineCap}if(i.lineWidth){this.context.strokeStyle=i.strokeStyle;this.context.lineWidth=i.lineWidth}if(i.shadowBlur){this.context.shadowBlur=i.shadowBlur;this.context.shadowColor=i.shadowColor;this.context.shadowOffsetX=i.shadowOffsetX;this.context.shadowOffsetY=i.shadowOffsetY}if(e instanceof t.Circle){this.context.beginPath();this.context.arc(0,0,i.radius,i.start*Math.PI/180,i.end*Math.PI/180,i.counterclockwise);if(i.fillStyle){this.context.fill()}if(i.strokePosition==="inset"){this.context.closePath();this.context.beginPath();this.context.arc(0,0,i.radius-i.lineWidth/2,i.start*Math.PI/180,i.end*Math.PI/180,i.counterclockwise)}else if(i.strokePosition==="outset"){this.context.closePath();this.context.beginPath();this.context.arc(0,0,i.radius+i.lineWidth/2,i.start*Math.PI/180,i.end*Math.PI/180,i.counterclockwise)}if(i.lineWidth){this.context.stroke()}this.context.closePath()}else if(e instanceof t.Image&&e.isLoaded){if(i.frames.length){o=i.frames[e.frame]}for(r=0;r<i.tileX;r+=1){for(l=0;l<i.tileY;l+=1){if(s.x+i.width*(r+1)<0||s.y+i.height*(l+1)<0||s.x+i.width*r>this.canvas.width||s.y+i.height*l>this.canvas.height){break}e.setMetrics({width:s.width*(r+1),height:s.height*(l+1)});this.context.drawImage(e.img,i.width*o+i.offsetX,i.offsetY,i.width,i.height,i.width*r,i.height*l,i.width,i.height)}}if(i.frames.length){if(!e.ftime){e.ftime=this.ftime;if(typeof i.callback==="function"){i.callback.call(e,i.frames[e.frame])}}if(this.ftime-e.ftime>=i.speed){e.ftime=this.ftime;e.frame+=1;if(e.frame>=i.frames.length){if(i.loop){e.frame=0}else{e.frame=i.frames.length-1}}if(typeof i.callback==="function"){i.callback.call(e,i.frames[e.frame])}}}}else if(e instanceof t.Line){this.context.beginPath();this.context.moveTo(0,0);this.context.lineTo(i.endX-i.startX,i.endY-i.startY);this.context.stroke();this.context.closePath()}else if(e instanceof t.Rect){this.context.beginPath();if(i.borderRadius){n=Math.min(i.borderRadius,i.height/2,i.width/2);this.context.moveTo(n,0);this.context.arc(i.width-n,n,n,Math.PI*1.5,0);this.context.arc(i.width-n,i.height-n,n,0,Math.PI*.5);this.context.arc(n,i.height-n,n,Math.PI*.5,Math.PI);this.context.arc(n,n,n,Math.PI,Math.PI*1.5);if(i.fillStyle){this.context.fill()}if(i.lineWidth){this.context.stroke()}}else{if(i.fillStyle){this.context.fillRect(0,0,i.width,i.height)}if(i.lineWidth){if(i.strokePosition==="inset"){this.context.closePath();this.context.beginPath();this.context.strokeRect(i.lineWidth/2,i.lineWidth/2,i.width-i.lineWidth,i.height-i.lineWidth)}else if(i.strokePosition==="outset"){this.context.closePath();this.context.beginPath();this.context.strokeRect(-i.lineWidth/2,-i.lineWidth/2,i.width+i.lineWidth,i.height+i.lineWidth)}else{this.context.strokeRect(0,0,i.width,i.height)}}}this.context.closePath()}else if(e instanceof t.Text){this.context.font=i.fontStyle+" "+parseInt(i.fontSize,10)+"px "+i.fontFamily;this.context.textBaseline=i.textBaseline;if(Object.prototype.toString.call(i.value)!=="[object Array]"){i.value=i.value.toString().split(/[ ]*\n[ ]*/)}if(i.lineHeight===null){i.lineHeight=i.fontSize}for(h=0,a=i.value.length;h<a;h+=1){if(i.textAlign==="center"){o=(i.width-this.context.measureText(i.value[h]).width)/2}else if(i.textAlign==="right"){o=i.width-this.context.measureText(i.value[h]).width}if(i.fillStyle){this.context.fillText(i.value[h],o,h*parseInt(i.lineHeight,10))}if(i.lineWidth){this.context.strokeText(i.value[h],o,h*parseInt(i.lineHeight,10))}}}this.context.restore();return this};t.prototype.animate=function(t){if(typeof this.callback==="function"){if(this.ftime){this.dt=t-this.ftime;this.fps=(1e3/this.dt).toFixed(2)}this.requestAnimation=window.requestAnimationFrame(this.animate.bind(this));this.ftime=t;this.callback.call(this)}else{this.stop()}return this};t.prototype.clear=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);return this};t.prototype.draw=function(t){this.callback=t;this.start();return this};t.prototype.exportBase64=function(t,e){if(!t){t="image/png"}if(typeof e==="number"){e=e/100}else{e=1}return this.canvas.toDataURL(t,e)};t.prototype.setAnchorPoint=function(e,i){var s=0,n=0,o,h;if(e instanceof t.Circle){i.width=i.radius*2;i.height=i.radius*2}else if(e instanceof t.Line){i.width=Math.abs(i.endX-i.startX);i.height=Math.abs(i.endY-i.startY)}else if(e instanceof t.Text){this.context.font=i.fontStyle+" "+parseInt(i.fontSize,10)+"px "+i.fontFamily;if(Object.prototype.toString.call(i.value)!=="[object Array]"){i.value=i.value.toString().split(/[ ]*\n[ ]*/)}if(i.lineHeight===null){i.lineHeight=i.fontSize}for(o=0,h=i.value.length;o<h;o+=1){i.width=Math.max(i.width,this.context.measureText(i.value[o]).width)}i.height=h*parseInt(i.lineHeight,10)}e.setMetrics({width:i.width*i.scale,height:i.height*i.scale});if(typeof i.lineWidth!=="undefined"){if(i.strokePosition==="default"){e.setMetrics({width:e.getMetric("width")+i.lineWidth/2,height:e.getMetric("height")+i.lineWidth/2})}else if(i.strokePosition==="outset"){e.setMetrics({width:e.getMetric("width")+i.lineWidth,height:e.getMetric("height")+i.lineWidth})}}if(i.anchor.match(/^top/)){if(typeof i.radius!=="undefined"){n=i.radius}if(typeof i.lineWidth!=="undefined"){if(i.strokePosition==="default"){n+=i.lineWidth/2}else if(i.strokePosition==="outset"){n+=i.lineWidth}}}else if(i.anchor.match(/^bottom/)){if(typeof i.radius!=="undefined"){n=-i.radius}else{n=-i.height}if(typeof i.lineWidth!=="undefined"){if(i.strokePosition==="default"){n-=i.lineWidth/2}else if(i.strokePosition==="outset"){n-=i.lineWidth}}}else if(i.anchor.match(/^center/)){if(typeof i.radius==="undefined"){n=-(i.height/2)}}if(i.anchor.match(/left$/)){if(typeof i.radius!=="undefined"){s=i.radius}if(typeof i.lineWidth!=="undefined"){if(i.strokePosition==="default"){s+=i.lineWidth/2}else if(i.strokePosition==="outset"){s+=i.lineWidth}}}else if(i.anchor.match(/right$/)){if(typeof i.radius!=="undefined"){s=-i.radius}else{s=-i.width}if(typeof i.lineWidth!=="undefined"){if(i.strokePosition==="default"){s-=i.lineWidth/2}else if(i.strokePosition==="outset"){s-=i.lineWidth}}}else if(i.anchor.match(/center$/)){if(typeof i.radius==="undefined"){s=-(i.width/2)}}s=s*i.scale+i.x;n=n*i.scale+i.y;if(e instanceof t.Circle){e.setMetrics({x:s-e.getMetric("width")/2,y:n-e.getMetric("height")/2})}else{e.setMetrics({x:s,y:n})}this.context.translate(s,n);return this};t.prototype.setRotate=function(t,e){var i,s=0,n=0;i=t.getAllMetrics();if(e.anchor.match(/^bottom/)){n=i.height}else if(e.anchor.match(/^center/)){n=i.height/2}if(e.anchor.match(/right$/)){s=i.width}else if(e.anchor.match(/center$/)){s=i.width/2}if(e.rotate){this.context.translate(s,n);this.context.rotate(e.rotate*Math.PI/180);this.context.translate(-s,-n)}return this};t.prototype.start=function(){this.requestAnimation=window.requestAnimationFrame(this.animate.bind(this));return this};t.prototype.stop=function(){this.dt=0;this.fps=0;this.ftime=0;this.requestAnimation=window.cancelAnimationFrame(this.requestAnimation);return this};t.Entity=function(){};t.Entity.prototype.defaultOptions=function(){var e={x:0,y:0,shadowBlur:0,shadowColor:"#000",shadowOffsetX:0,shadowOffsetY:0,anchor:"top/left",opacity:100,rotate:0,scale:1};if(this instanceof t.Circle){e.radius=10;e.start=0;e.end=360;e.counterclockwise=false;e.fillStyle="#000";e.strokeStyle="#000";e.strokePosition="default";e.lineWidth=0}else if(this instanceof t.Image){e.width=null;e.height=null;e.offsetX=0;e.offsetY=0;e.tileX=1;e.tileY=1;e.frames=[];e.speed=120;e.loop=true;e.callback=function(t){}}else if(this instanceof t.Line){e.startX=0;e.startY=0;e.endX=0;e.endY=0;e.strokeStyle="#000";e.lineWidth=0;e.lineCap=null}else if(this instanceof t.Rect){e.width=100;e.height=100;e.fillStyle="#000";e.strokeStyle="#000";e.strokePosition="default";e.lineWidth=0;e.borderRadius=0}else if(this instanceof t.Text){e.width=0;e.value="";e.fontFamily="Arial";e.fontSize=30;e.fontStyle="normal";e.lineHeight=null;e.textAlign="left";e.textBaseline="top";e.fillStyle="#000";e.strokeStyle="#000";e.lineWidth=0}return e};t.Entity.prototype.getOption=function(t){if(this._options.hasOwnProperty(t)){return this._options[t]}return false};t.Entity.prototype.getAllOptions=function(){var t={},e;for(e in this._options){if(this._options.hasOwnProperty(e)){t[e]=this._options[e]}}return t};t.Entity.prototype.setOptions=function(t,e){var i={},s;for(s in this._options){if(this._options.hasOwnProperty(s)){if(t&&t.hasOwnProperty(s)){i[s]=t[s];if(e!==true){this._options[s]=t[s]}}else{i[s]=this._options[s]}}}return i};t.Entity.prototype.defaultMetrics=function(){var t={x:null,y:null,width:null,height:null};return t};t.Entity.prototype.getMetric=function(t){if(this._metrics.hasOwnProperty(t)){return this._metrics[t]}return false};t.Entity.prototype.getAllMetrics=function(){var t={},e;for(e in this._metrics){if(this._metrics.hasOwnProperty(e)){t[e]=this._metrics[e]}}return t};t.Entity.prototype.setMetrics=function(t,e){var i={},s;for(s in this._metrics){if(this._metrics.hasOwnProperty(s)){if(t&&t.hasOwnProperty(s)){i[s]=t[s];if(e!==true){this._metrics[s]=t[s]}}else{i[s]=this._metrics[s]}}}return i};t.Circle=function(e){if(!(this instanceof t.Circle)){return new t.Circle(e)}this._options=this.defaultOptions();this._metrics=this.defaultMetrics();this.setOptions(e)};t.Circle.prototype=Object.create(t.Entity.prototype);t.Image=function(e,i){if(!(this instanceof t.Image)){return new t.Image(i)}this._options=this.defaultOptions();this._metrics=this.defaultMetrics();if(e===undefined){throw new Error('Required parameter "source" missing from Facade.Image call.')}this.img=null;this.frame=0;this.ftime=null;this.isLoaded=false;this.size={width:null,height:null};this.loaded=function(){var t=this.getAllOptions();this.isLoaded=true;this.size={width:this.img.width,height:this.img.height};if(!t.width||t.width+t.offsetX>this.size.width){this.setOptions({width:this.size.width-this._options.offsetX})}if(!t.height||t.height+t.offsetY>this.size.height){this.setOptions({height:this.size.height-this._options.offsetY})}};if(typeof e==="object"&&e.nodeType===1){this.img=e;if(this.img.complete){this.loaded.call(this)}else{this.img.addEventListener("load",this.loaded.bind(this))}}else{this.img=document.createElement("img");this.img.setAttribute("src",e);this.img.addEventListener("load",this.loaded.bind(this))}this.setOptions(i)};t.Image.prototype=Object.create(t.Entity.prototype);t.Line=function(e){if(!(this instanceof t.Line)){return new t.Line(e)}this._options=this.defaultOptions();this._metrics=this.defaultMetrics();this.setOptions(e)};t.Line.prototype=Object.create(t.Entity.prototype);t.Rect=function(e){if(!(this instanceof t.Rect)){return new t.Rect(e)}this._options=this.defaultOptions();this._metrics=this.defaultMetrics();this.setOptions(e)};t.Rect.prototype=Object.create(t.Entity.prototype);t.Text=function(e){if(!(this instanceof t.Text)){return new t.Text(e)}this._options=this.defaultOptions();this._metrics=this.defaultMetrics();this.setOptions(e)};t.Text.prototype=Object.create(t.Entity.prototype);return t}();