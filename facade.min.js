/*!
 * Facade.js (facadejs.com)
 * Copyright (c) 2013 Scott Doxey
 * Dual-licensed under both MIT and BSD licenses.
 */
/*jslint browser: true*/
/*jslint nomen: true*/
var Facade=function(){"use strict";["webkit","moz"].forEach(function(t){window.requestAnimationFrame=window.requestAnimationFrame||window[t+"RequestAnimationFrame"]||null;window.cancelAnimationFrame=window.cancelAnimationFrame||window[t+"CancelAnimationFrame"]||null});var t=document.createElement("canvas").getContext("2d");function i(t){return Object.prototype.toString.call(t)==="[object Array]"?true:false}function e(t,i,s){if(!(this instanceof e)){return new e(t,i,s)}if(t&&typeof t==="object"&&t.nodeType===1){this.canvas=t}else{this.canvas=document.createElement("canvas");if(typeof t==="string"){this.canvas.setAttribute("id",t)}}if(i&&s){this.canvas.setAttribute("width",parseInt(i,10));this.canvas.setAttribute("height",parseInt(s,10))}try{this.context=this.canvas.getContext("2d")}catch(o){throw new Error("Parameter passed to Facade.js is not a valid canvas element")}this.dt=0;this.fps=0;this.ftime=null;this._callback=null;this._requestAnimation=null}e.prototype.addToStage=function(t,i){if(!(t instanceof e.Entity)){throw new Error("Parameter passed to Facade.addToStage is not a valid Facade.js object")}if(t.isVisible(this.canvas)){this.context.save();t._draw.call(t,this,i?t.setOptions(i,true):t.getAllOptions());this.context.restore()}return this};e.prototype._animate=function(t){if(typeof this._callback==="function"){if(this.ftime){this.dt=t-this.ftime;this.fps=(1e3/this.dt).toFixed(2)}this._requestAnimation=window.requestAnimationFrame(this._animate.bind(this));this.ftime=t;this.context.save();this._callback.call(this);this.context.restore()}else{this.stop()}return this};e.prototype.clear=function(){this.context.clearRect(0,0,this.width(),this.height());return this};e.prototype.draw=function(t){if(typeof t==="function"){this._callback=t;this.start()}else{throw new Error("Parameter passed to Facade.draw is not a valid function")}return this};e.prototype.exportBase64=function(t,i){if(!t){t="image/png"}if(typeof i==="number"){i=i/100}else{i=1}return this.canvas.toDataURL(t,i)};e.prototype.height=function(){return this.canvas.height};e.prototype.start=function(){this._requestAnimation=window.requestAnimationFrame(this._animate.bind(this));return this};e.prototype.stop=function(){this.dt=0;this.fps=0;this.ftime=0;this._requestAnimation=window.cancelAnimationFrame(this._requestAnimation);return this};e.prototype.width=function(){return this.canvas.width};e.Entity=function(){};e.Entity.prototype.defaultOptions=function(){return{x:0,y:0,shadowBlur:0,shadowColor:"#000",shadowOffsetX:0,shadowOffsetY:0,anchor:"top/left",opacity:100,flip:"",rotate:0,scale:1}};e.Entity.prototype._setContext=function(t,i){var e=this._setMetrics(i,true),s=this._getRotatePoint(i,e),o=i.flip.match(/horizontal/),n=i.flip.match(/vertical/);t.translate(e.x,e.y);if(i.rotate&&(s[0]||s[1])){t.translate(s[0],s[1]);t.rotate(i.rotate*Math.PI/180);t.translate(-s[0],-s[1])}if(o){t.translate(e.width,0)}if(n){t.translate(0,e.height)}t.scale(i.scale,i.scale);if(o){t.scale(-1,1)}if(n){t.scale(1,-1)}t.globalAlpha=i.opacity/100;if(i.fillStyle){t.fillStyle=i.fillStyle}if(i.lineCap){t.lineCap=i.lineCap}if(i.lineWidth){t.lineWidth=i.lineWidth;t.strokeStyle=i.strokeStyle}if(i.shadowBlur){t.shadowBlur=i.shadowBlur;t.shadowColor=i.shadowColor;t.shadowOffsetX=i.shadowOffsetX;t.shadowOffsetY=i.shadowOffsetY}if(i.fontStyle){t.font=i.fontStyle+" "+i.fontSize+"px "+i.fontFamily;t.textBaseline=i.textBaseline}};e.Entity.prototype.getOption=function(t){if(this._options.hasOwnProperty(t)){return this._options[t]}return undefined};e.Entity.prototype.getAllOptions=function(){var t={},i;for(i in this._options){if(this._options.hasOwnProperty(i)){t[i]=this._options[i]}}return t};e.Entity.prototype.setOptions=function(t,i){var e={},s;for(s in this._options){if(this._options.hasOwnProperty(s)){if(t&&t.hasOwnProperty(s)){if(typeof this._options[s]===typeof t[s]){e[s]=t[s];if(i!==true){this._options[s]=t[s]}}else{throw new Error("The value for "+s+" was a "+typeof t[s]+" not a "+typeof this._options[s])}}else{e[s]=this._options[s]}}}this._setMetrics(e,i);return e};e.Entity.prototype.defaultMetrics=function(){return{x:null,y:null,width:null,height:null}};e.Entity.prototype.getMetric=function(t){if(this._metrics.hasOwnProperty(t)){return this._metrics[t]}return undefined};e.Entity.prototype.getAllMetrics=function(){var t={},i;for(i in this._metrics){if(this._metrics.hasOwnProperty(i)){t[i]=this._metrics[i]}}return t};e.Entity.prototype.isVisible=function(t){if(t&&typeof t==="object"&&t.nodeType===1){if(this._metrics.x<t.width&&this._metrics.x+this._metrics.width>0&&this._metrics.y<t.height&&this._metrics.y+this._metrics.height>0){return true}}else{throw new Error("Parameter passed to Facade.Entity.isVisible is not a valid canvas element")}return false};e.Entity.prototype._getAnchorPoint=function(t,i){var e=t.x,s=t.y;if(t.anchor.match(/^center/)){s=t.y-i.height/2}else if(t.anchor.match(/^bottom/)){s=t.y-i.height}if(t.anchor.match(/center$/)){e=t.x-i.width/2}else if(t.anchor.match(/right$/)){e=t.x-i.width}return[e,s]};e.Entity.prototype._getRotatePoint=function(t,i){var e=0,s=0;if(t.anchor.match(/^center/)){s=i.height/2}else if(t.anchor.match(/^bottom/)){s=i.height}if(t.anchor.match(/center$/)){e=i.width/2}else if(t.anchor.match(/right$/)){e=i.width}return[e,s]};e.Circle=function(t){if(!(this instanceof e.Circle)){return new e.Circle(t)}this._options=this.defaultOptions();this._metrics=this.defaultMetrics();this._options.radius=10;this._options.start=0;this._options.end=360;this._options.counterclockwise=false;this._options.fillStyle="#000";this._options.strokeStyle="#000";this._options.strokePosition="default";this._options.lineWidth=0;this._options.lineCap="butt";this.setOptions(t)};e.Circle.prototype=Object.create(e.Entity.prototype);e.Circle.prototype._draw=function(t,i){var e=t.context,s=0;this._setContext(e,i);e.beginPath();e.arc(0,0,i.radius,i.start*Math.PI/180,i.end*Math.PI/180,i.counterclockwise);if(i.fillStyle){e.fill()}if(i.strokePosition.match(/(in|out)set/)){if(i.strokePosition==="inset"){s=-(i.lineWidth/2)}else if(i.strokePosition==="outset"){s=i.lineWidth/2}e.closePath();e.beginPath();e.arc(0,0,i.radius+s,i.start*Math.PI/180,i.end*Math.PI/180,i.counterclockwise)}if(i.lineWidth){e.stroke()}e.closePath()};e.Circle.prototype._setMetrics=function(t,i){var e=this.getAllMetrics(),s,o=0;if(t.strokePosition==="default"){o=t.lineWidth/2}else if(t.strokePosition==="outset"){o=t.lineWidth}e.width=(t.radius+o)*2*t.scale;e.height=(t.radius+o)*2*t.scale;s=this._getAnchorPoint(t,e);e.x=s[0]+(t.radius+o)*t.scale;e.y=s[1]+(t.radius+o)*t.scale;if(i!==true){this._metrics=e}return e};e.Image=function(t,i){if(typeof t==="undefined"){throw new Error('Required parameter "source" missing from Facade.Image call')}if(!(this instanceof e.Image)){return new e.Image(i)}this._options=this.defaultOptions();this._metrics=this.defaultMetrics();this._options.width=0;this._options.height=0;this._options.offsetX=0;this._options.offsetY=0;this._options.tileX=1;this._options.tileY=1;this._options.frames=[];this._options.speed=120;this._options.loop=true;this._options.callback=function(t){};this.image=this.load(t,i);this.currentFrame=0;this.isAnimating=false};e.Image.prototype=Object.create(e.Entity.prototype);e.Image.prototype.play=function(){this.isAnimating=true;return this};e.Image.prototype.pause=function(){this.isAnimating=false;return this};e.Image.prototype.reset=function(){this.currentFrame=0;return this};e.Image.prototype.stop=function(){this.currentFrame=0;this.isAnimating=false;return this};e.Image.prototype.load=function(t,i){var e;if(typeof t==="object"&&t.nodeType===1){e=t;if(e.complete){this.setOptions.call(this,i)}else{e.addEventListener("load",this.setOptions.bind(this,i))}}else{e=document.createElement("img");e.setAttribute("src",t);e.addEventListener("load",this.setOptions.bind(this,i))}return e};e.Image.prototype._draw=function(t,i){var e=t.context,s=0,o=0,n=0;if(this.image.complete){this._setContext(e,i);if(i.frames.length){s=i.frames[this.currentFrame]||0}for(o=0;o<i.tileX;o+=1){for(n=0;n<i.tileY;n+=1){e.drawImage(this.image,i.width*s+i.offsetX,i.offsetY,i.width,i.height,i.width*o,i.height*n,i.width,i.height)}}if(this.isAnimating&&i.frames.length){if(!this.ftime){this.ftime=t.ftime;if(typeof i.callback==="function"){i.callback.call(this,i.frames[this.currentFrame])}}if(t.ftime-this.ftime>=i.speed){this.ftime=t.ftime;this.currentFrame+=1;if(this.currentFrame>=i.frames.length){if(i.loop){this.currentFrame=0}else{this.currentFrame=i.frames.length-1;this.isAnimating=false}}if(typeof i.callback==="function"){i.callback.call(this,i.frames[this.currentFrame])}}}}};e.Image.prototype._setMetrics=function(t,i){var e=this.getAllMetrics(),s;if(this.image.complete){t.width=t.width||this.image.width;t.height=t.height||this.image.height;e.width=t.width*t.tileX*t.scale;e.height=t.height*t.tileY*t.scale;s=this._getAnchorPoint(t,e);e.x=s[0];e.y=s[1];if(i!==true){this._metrics=e}return e}};e.Line=function(t){if(!(this instanceof e.Line)){return new e.Line(t)}this._options=this.defaultOptions();this._metrics=this.defaultMetrics();this._options.startX=0;this._options.startY=0;this._options.endX=0;this._options.endY=0;this._options.strokeStyle="#000";this._options.lineWidth=0;this._options.lineCap="butt";this.setOptions(t)};e.Line.prototype=Object.create(e.Entity.prototype);e.Line.prototype._draw=function(t,i){var e=t.context;this._setContext(e,i);e.beginPath();e.moveTo(0,0);e.lineTo(i.endX-i.startX,i.endY-i.startY);e.stroke();e.closePath()};e.Line.prototype._setMetrics=function(t,i){var e=this.getAllMetrics(),s;e.width=Math.abs(t.endX-t.startX)*t.scale;e.height=Math.abs(t.endY-t.startY)*t.scale;s=this._getAnchorPoint(t,e);e.x=s[0];e.y=s[1];if(i!==true){this._metrics=e}return e};e.Rect=function(t){if(!(this instanceof e.Rect)){return new e.Rect(t)}this._options=this.defaultOptions();this._metrics=this.defaultMetrics();this._options.width=100;this._options.height=100;this._options.fillStyle="#000";this._options.strokeStyle="#000";this._options.strokePosition="default";this._options.lineWidth=0;this._options.borderRadius=0;this.setOptions(t)};e.Rect.prototype=Object.create(e.Entity.prototype);e.Rect.prototype._draw=function(t,i){var e=t.context,s;this._setContext(e,i);e.beginPath();if(i.borderRadius){s=Math.min(i.borderRadius,i.height/2,i.width/2);e.moveTo(s,0);e.arc(i.width-s,s,s,Math.PI*1.5,0);e.arc(i.width-s,i.height-s,s,0,Math.PI*.5);e.arc(s,i.height-s,s,Math.PI*.5,Math.PI);e.arc(s,s,s,Math.PI,Math.PI*1.5);if(i.fillStyle){e.fill()}if(i.lineWidth){e.stroke()}}else{if(i.fillStyle){e.fillRect(0,0,i.width,i.height)}if(i.lineWidth){if(i.strokePosition==="inset"){e.strokeRect(i.lineWidth/2,i.lineWidth/2,i.width-i.lineWidth,i.height-i.lineWidth)}else if(i.strokePosition==="outset"){e.strokeRect(-i.lineWidth/2,-i.lineWidth/2,i.width+i.lineWidth,i.height+i.lineWidth)}else{e.strokeRect(0,0,i.width,i.height)}}}e.closePath()};e.Rect.prototype._setMetrics=function(t,i){var e=this.getAllMetrics(),s,o=0;if(t.strokePosition==="default"){o=t.lineWidth/2}else if(t.strokePosition==="outset"){o=t.lineWidth}e.width=(t.width+o*2)*t.scale;e.height=(t.height+o*2)*t.scale;s=this._getAnchorPoint(t,e);e.x=s[0]+o*t.scale;e.y=s[1]+o*t.scale;if(i!==true){this._metrics=e}return e};e.Text=function(t){if(!(this instanceof e.Text)){return new e.Text(t)}this._options=this.defaultOptions();this._metrics=this.defaultMetrics();this._options.width=0;this._options.value="";this._options.fontFamily="Arial";this._options.fontSize=30;this._options.fontStyle="normal";this._options.lineHeight=30;this._options.textAlign="left";this._options.textBaseline="top";this._options.fillStyle="#000";this._options.strokeStyle="#000";this._options.lineWidth=0;this.setOptions(t)};e.Text.prototype=Object.create(e.Entity.prototype);e.Text.prototype._draw=function(t,e){var s=t.context,o=0,n,r;this._setContext(s,e);if(!i(e.value)){e.value=e.value.split(/[ ]*\n[ ]*/)}for(n=0,r=e.value.length;n<r;n+=1){if(e.textAlign==="center"){o=(e.width-s.measureText(e.value[n]).width)/2}else if(e.textAlign==="right"){o=e.width-s.measureText(e.value[n]).width}if(e.fillStyle){s.fillText(e.value[n],o,n*e.lineHeight)}if(e.lineWidth){s.strokeText(e.value[n],o,n*e.lineHeight)}}};e.Text.prototype._setMetrics=function(e,s){var o=this.getAllMetrics(),n,r,h;t.font=e.fontStyle+" "+e.fontSize+"px "+e.fontFamily;if(!i(e.value)){e.value=e.value.split(/[ ]*\n[ ]*/)}for(r=0,h=e.value.length;r<h;r+=1){e.width=Math.max(e.width,t.measureText(e.value[r]).width)}e.height=h*e.lineHeight;o.width=e.width*e.scale;o.height=e.height*e.scale;n=this._getAnchorPoint(e,o);o.x=n[0];o.y=n[1];if(s!==true){this._metrics=o}return o};if(typeof window.define==="function"&&window.define.hasOwnProperty("amd")){window.define([],function(){return e})}return e}();